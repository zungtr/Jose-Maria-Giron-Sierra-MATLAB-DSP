% Complex 2D dual-tree wavelets display

NS=4; %number of stages
L=3*(2^(NS+1));
M=L/(2^NS);
fg=zeros(2*L,6*L); %blank image

%First filter coeffs.------------------------------
af1{1} = [
                  0                  0
  -0.08838834764832  -0.01122679215254
   0.08838834764832   0.01122679215254
   0.69587998903400   0.08838834764832
   0.69587998903400   0.08838834764832
   0.08838834764832  -0.69587998903400
  -0.08838834764832   0.69587998903400
   0.01122679215254  -0.08838834764832
   0.01122679215254  -0.08838834764832
                  0                  0
 ];
   
sf1{1} = af1{1}(end:-1:1, :);

af1{2} = [
   0.01122679215254                  0
   0.01122679215254                  0
  -0.08838834764832  -0.08838834764832
   0.08838834764832  -0.08838834764832
   0.69587998903400   0.69587998903400
   0.69587998903400  -0.69587998903400
   0.08838834764832   0.08838834764832
  -0.08838834764832   0.08838834764832
                  0   0.01122679215254
                  0  -0.01122679215254
];

sf1{2} = af1{2}(end:-1:1, :);

%The other filter coeffs.------------------------------

aff{1} = [
   0.03516384000000                  0
                  0                  0
  -0.08832942000000  -0.11430184000000
   0.23389032000000                  0
   0.76027237000000   0.58751830000000
   0.58751830000000  -0.76027237000000
                  0   0.23389032000000
  -0.11430184000000   0.08832942000000
                  0                  0
                  0  -0.03516384000000
 ];
 
aff{2} = [
                  0  -0.03516384000000
                  0                  0
  -0.11430184000000   0.08832942000000
                  0   0.23389032000000
   0.58751830000000  -0.76027237000000
   0.76027237000000   0.58751830000000
   0.23389032000000                  0
  -0.08832942000000  -0.11430184000000
                  0                  0
   0.03516384000000                  0
];
 
sff{1} = aff{1}(end:-1:1, :); 
sff{2} = aff{2}(end:-1:1, :);

%wavelet coeffs as cells:-------------------------------
% w{s}{p}{d1}{d2}
% s=1:NS, scale; p=1(real part),2(imaginary part)
% orientations d1=1..2, d2=1..3
% w(NS+1}{m}{n} - low-pass coeffs


%Complex 2D Dual-tree transform --------------

fg=fg/2; %normalize

for m=1:2,
   for n=1:2,
      [LO w{1}{m}{n}]=D_afilt(fg,af1{m},af1{n}); 
      for nj=2:NS,
         [LO w{nj}{m}{n}]=D_afilt(LO,aff{m},aff{n});
      end;
      w{NS+1}{m}{n}=LO; %low-pass coeffs.
   end;
end;   

q=sqrt(2);
for nj=1:NS,
   for m=1:3,
      auxa=w{nj}{1}{1}{m}; auxb=w{nj}{2}{2}{m};
      w{nj}{1}{1}{m}=(auxa+auxb)/q;
      w{nj}{2}{2}{m}=(auxa-auxb)/q;
      auxa=w{nj}{1}{2}{m}; auxb=w{nj}{2}{1}{m};
      w{nj}{1}{2}{m}=(auxa+auxb)/q;
      w{nj}{2}{1}{m}=(auxa-auxb)/q;
   end;
end;   

%Prepare for inversion experiment---------------

w{NS}{1}{2}{2}(M/2,M/2)=1;
w{NS}{1}{1}{3}(M/2,M/2+M)=1;
w{NS}{1}{2}{1}(M/2,M/2+2*M)=1;
w{NS}{1}{1}{1}(M/2,M/2+3*M)=1;
w{NS}{1}{2}{3}(M/2,M/2+4*M)=1;
w{NS}{1}{1}{2}(M/2,M/2+5*M)=1;
w{NS}{2}{2}{2}(M/2+M,M/2)=1;
w{NS}{2}{1}{3}(M/2+M,M/2+M)=1;
w{NS}{2}{2}{1}(M/2+M,M/2+2*M)=1;
w{NS}{2}{1}{1}(M/2+M,M/2+3*M)=1;
w{NS}{2}{2}{3}(M/2+M,M/2+4*M)=1;
w{NS}{2}{1}{2}(M/2+M,M/2+5*M)=1;


%Inverse complex 2D Dual-tree transform --------------
   
for nj=1:NS,
   for m=1:3,
      auxa=w{nj}{1}{1}{m}; auxb=w{nj}{2}{2}{m};
      w{nj}{1}{1}{m}=(auxa+auxb)/q;
      w{nj}{2}{2}{m}=(auxa-auxb)/q;
      auxa=w{nj}{1}{2}{m}; auxb=w{nj}{2}{1}{m};
      w{nj}{1}{2}{m}=(auxa+auxb)/q;
      w{nj}{2}{1}{m}=(auxa-auxb)/q;
   end;
end;   

y=zeros(size(w{1}{1}{1}{1})*2);
for m=1:2,
   for n=1:2,
      LO=w{NS+1}{m}{n};
      for nj=NS:-1:2,
         LO=D_sfilt(LO,w{nj}{m}{n},sff{m},sff{n});
      end;
      LO=D_sfilt(LO,w{1}{m}{n},sf1{m},sf1{n});
      y=y+LO;
   end;
end;  

y=y/2; %normalize

%display---------------------------------------------
figure(1)
aux=(y(1:L,:).^2+y(L+[1:L],:).^2);
y=[y; sqrt(aux)];
imagesc(y);
title('the Complex 2D wavelets');
axis image;
axis off;

